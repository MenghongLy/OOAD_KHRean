{% extends "base.html" %}

{% block title %}Grades{% endblock %}

{% block sidebar_subtitle %}Teacher Portal{% endblock %}

{% block sidebar_menu %}
<li>
    <a href="{{ url_for('teacher_bp.dashboard') }}">
        <i class="fas fa-home"></i>
        Dashboard
    </a>
</li>
<li>
    <a href="{{ url_for('teacher_bp.students') }}">
        <i class="fas fa-users"></i>
        My Students
    </a>
</li>
<li>
    <a href="{{ url_for('teacher_bp.classes') }}">
        <i class="fas fa-chalkboard"></i>
        Classes
    </a>
</li>
<li>
    <a href="{{ url_for('teacher_bp.assignments') }}">
        <i class="fas fa-tasks"></i>
        Assignments
    </a>
</li>
<li>
    <a href="{{ url_for('teacher_bp.grades') }}" class="active">
        <i class="fas fa-chart-line"></i>
        Grades
    </a>
</li>
<li>
    <a href="{{ url_for('teacher_bp.profile') }}">
        <i class="fas fa-user-edit"></i>
        Edit Profile
    </a>
</li>
<li style="margin-top: 2rem;">
    <a href="{{ url_for('auth_bp.logout') }}">
        <i class="fas fa-sign-out-alt"></i>
        Logout
    </a>
</li>
{% endblock %}

{% block search_placeholder %}Search grades...{% endblock %}

{% block user_avatar %}{{ teacher.user.username[0]|upper }}{% endblock %}
{% block user_name %}{{ teacher.user.username }}{% endblock %}
{% block user_id %}Teacher ID: {{ teacher.id }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div style="margin-bottom: 1.5rem;">
    <h2 style="font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">
        <i class="fas fa-chart-line"></i> Grades Management
    </h2>
    <p style="color: #6b7280; margin: 0;">View and manage student grades across all assignments</p>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card primary">
        <div class="stat-icon"><i class="fas fa-clipboard-check"></i></div>
        <div class="stat-value">{{ grades|length }}</div>
        <div class="stat-label">Total Submissions</div>
    </div>
    <div class="stat-card success">
        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
        <div class="stat-value">{{ grades|selectattr('status', 'equalto', 'Graded')|list|length }}</div>
        <div class="stat-label">Graded</div>
    </div>
    <div class="stat-card warning">
        <div class="stat-icon"><i class="fas fa-clock"></i></div>
        <div class="stat-value">{{ grades|selectattr('status', 'equalto', 'Pending')|list|length }}</div>
        <div class="stat-label">Pending</div>
    </div>
    <div class="stat-card info">
        <div class="stat-icon"><i class="fas fa-percentage"></i></div>
        <div class="stat-value">
            {% set graded_grades = grades|selectattr('grade', 'ne', 'Not graded')|map(attribute='grade')|list %}
            {% if graded_grades|length > 0 %}
            {{ (graded_grades|sum / graded_grades|length)|round(1) }}%
            {% else %}
            0%
            {% endif %}
        </div>
        <div class="stat-label">Average Grade</div>
    </div>
</div>

<!-- Filter Options -->
<div class="content-card" style="margin-bottom: 1.5rem;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Filter by
                Class</label>
            <select id="classFilter" class="form-select" style="border-radius: 10px;" onchange="filterGrades()">
                <option value="all">All Classes</option>
                {% for class in grades|map(attribute='class_name')|unique|list %}
                <option value="{{ class }}">{{ class }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Filter by
                Status</label>
            <select id="statusFilter" class="form-select" style="border-radius: 10px;" onchange="filterGrades()">
                <option value="all">All Status</option>
                <option value="graded">Graded</option>
                <option value="pending">Pending</option>
            </select>
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Search
                Student</label>
            <input type="text" id="searchInput" placeholder="Student name..." class="form-control"
                style="border-radius: 10px;" onkeyup="filterGrades()">
        </div>
        <div style="display: flex; align-items: flex-end;">
            <button class="btn-custom btn-success-custom" style="width: 100%;" onclick="exportGrades()">
                <i class="fas fa-download"></i> Export Grades
            </button>
        </div>
    </div>
</div>

<!-- Grades Table -->
<div class="content-card">
    <div class="card-header">
        <h4><i class="fas fa-list"></i> All Grades</h4>
        <div style="font-size: 0.9rem; color: #6b7280;">
            Showing <strong id="displayCount">{{ grades|length }}</strong> of {{ grades|length }} records
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover" id="gradesTable">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Class</th>
                    <th>Assignment</th>
                    <th>Submission Date</th>
                    <th>Grade</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for grade in grades %}
                <tr data-class="{{ grade.class_name }}" data-status="{{ grade.status|lower }}"
                    data-student="{{ grade.student_name|lower }}">
                    <td>
                        <strong>{{ grade.student_name }}</strong>
                    </td>
                    <td>
                        <span class="badge badge-submitted">{{ grade.class_name }}</span>
                    </td>
                    <td>{{ grade.assignment_title }}</td>
                    <td>{{ grade.submission_date }}</td>
                    <td>
                        {% if grade.grade != 'Not graded' %}
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <strong style="font-size: 1.1rem; 
                                {% if grade.grade >= 90 %}color: var(--success-color);
                                {% elif grade.grade >= 80 %}color: var(--info-color);
                                {% elif grade.grade >= 70 %}color: var(--warning-color);
                                {% else %}color: var(--danger-color);
                                {% endif %}">
                                {{ grade.grade }}%
                            </strong>
                            <div
                                style="flex: 1; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; width: {{ grade.grade }}%; 
                                    {% if grade.grade >= 90 %}background: var(--success-color);
                                    {% elif grade.grade >= 80 %}background: var(--info-color);
                                    {% elif grade.grade >= 70 %}background: var(--warning-color);
                                    {% else %}background: var(--danger-color);
                                    {% endif %}"></div>
                            </div>
                        </div>
                        {% else %}
                        <span style="color: #9ca3af;">Not graded</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if grade.status == 'Graded' %}
                        <span class="badge badge-graded">{{ grade.status }}</span>
                        {% else %}
                        <span class="badge badge-pending">{{ grade.status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if grade.status == 'Pending' %}
                        <button class="btn-custom btn-primary-custom" style="padding: 0.4rem 1rem; font-size: 0.85rem;"
                            onclick="gradeModal({{ grade.submission_id }}, '{{ grade.student_name }}', '{{ grade.assignment_title }}', null)">
                            <i class="fas fa-edit"></i> Grade
                        </button>
                        {% else %}
                        <button class="btn-custom btn-outline-custom" style="padding: 0.4rem 1rem; font-size: 0.85rem;"
                            onclick="gradeModal({{ grade.submission_id }}, '{{ grade.student_name }}', '{{ grade.assignment_title }}', {{ grade.grade }})">
                            <i class="fas fa-pen"></i> Edit
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <i class="fas fa-chart-line"></i>
                            <h5>No grades yet</h5>
                            <p>Student submissions will appear here for grading</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Grade Modal -->
<div class="modal fade" id="gradeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 15px; border: none;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border-radius: 15px 15px 0 0;">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Grade Submission</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="gradeForm">
                <input type="hidden" name="submission_id" id="submissionId">
                <div class="modal-body">
                    <p style="margin-bottom: 0.5rem;"><strong>Student:</strong> <span id="studentName"></span></p>
                    <p style="margin-bottom: 1rem; color: #6b7280;"><strong>Assignment:</strong> <span
                            id="assignmentTitle"></span></p>
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 500;">Grade (0-100) *</label>
                        <input type="number" class="form-control" name="grade" id="gradeInput" min="0" max="100"
                            step="0.1" required style="border-radius: 10px;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 500;">Feedback</label>
                        <textarea class="form-control" name="feedback" id="feedbackInput" rows="4"
                            style="border-radius: 10px;" placeholder="Provide feedback to the student..."></textarea>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 2px solid var(--light-bg);">
                    <button type="button" class="btn-custom btn-outline-custom" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn-custom btn-primary-custom">
                        <i class="fas fa-save"></i> Save Grade
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function filterGrades() {
        const classFilter = document.getElementById('classFilter').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
        const searchValue = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('#gradesTable tbody tr');

        let visibleCount = 0;

        rows.forEach(row => {
            const rowClass = row.getAttribute('data-class')?.toLowerCase() || '';
            const rowStatus = row.getAttribute('data-status')?.toLowerCase() || '';
            const rowStudent = row.getAttribute('data-student')?.toLowerCase() || '';

            const classMatch = classFilter === 'all' || rowClass === classFilter;
            const statusMatch = statusFilter === 'all' || rowStatus === statusFilter;
            const searchMatch = searchValue === '' || rowStudent.includes(searchValue) ||
                row.textContent.toLowerCase().includes(searchValue);

            if (classMatch && statusMatch && searchMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        document.getElementById('displayCount').textContent = visibleCount;
    }

    function gradeModal(submissionId, studentName, assignmentTitle, currentGrade) {
        document.getElementById('submissionId').value = submissionId;
        document.getElementById('studentName').textContent = studentName;
        document.getElementById('assignmentTitle').textContent = assignmentTitle;
        document.getElementById('gradeInput').value = currentGrade || '';

        const modal = new bootstrap.Modal(document.getElementById('gradeModal'));
        modal.show();
    }

    // Grade form submission
    document.getElementById('gradeForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const submissionId = document.getElementById('submissionId').value;
        const formData = new FormData(this);
        formData.append('csrf_token', getCSRFToken());

        fetch(`/teacher/submissions/${submissionId}/grade`, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error grading submission: ' + error);
            });
    });

    function exportGrades() {
        fetch('{{ url_for("teacher_bp.export_grades") }}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Convert to CSV
                    let csv = 'Student,Class,Assignment,Grade\n';
                    data.data.forEach(row => {
                        csv += `"${row.student}","${row.class}","${row.assignment}","${row.grade}"\n`;
                    });

                    // Download
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'grades_export.csv';
                    a.click();
                } else {
                    alert('Error exporting grades');
                }
            })
            .catch(error => {
                alert('Error exporting grades: ' + error);
            });
    }
</script>
{% endblock %}