{% extends "base.html" %}

{% block title %}Assignments{% endblock %}

{% block sidebar_subtitle %}Teacher Portal{% endblock %}

{% block sidebar_menu %}
<li>
    <a href="{{ url_for('teacher_bp.dashboard') }}">
        <i class="fas fa-home"></i>
        Dashboard
    </a>
</li>
<li>
    <a href="{{ url_for('teacher_bp.students') }}">
        <i class="fas fa-users"></i>
        My Students
    </a>
</li>
<li>
    <a href="{{ url_for('teacher_bp.classes') }}">
        <i class="fas fa-chalkboard"></i>
        Classes
    </a>
</li>
<li>
    <a href="{{ url_for('teacher_bp.assignments') }}" class="active">
        <i class="fas fa-tasks"></i>
        Assignments
    </a>
</li>
<li>
    <a href="{{ url_for('teacher_bp.grades') }}">
        <i class="fas fa-chart-line"></i>
        Grades
    </a>
</li>
<li>
    <a href="{{ url_for('teacher_bp.profile') }}">
        <i class="fas fa-user-edit"></i>
        Edit Profile
    </a>
</li>
<li style="margin-top: 2rem;">
    <a href="{{ url_for('auth_bp.logout') }}">
        <i class="fas fa-sign-out-alt"></i>
        Logout
    </a>
</li>
{% endblock %}

{% block search_placeholder %}Search assignments...{% endblock %}

{% block user_avatar %}{{ teacher.user.username[0]|upper }}{% endblock %}
{% block user_name %}{{ teacher.user.username }}{% endblock %}
{% block user_id %}Teacher ID: {{ teacher.id }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h2 style="font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">
            <i class="fas fa-tasks"></i> Assignments
        </h2>
        <p style="color: #6b7280; margin: 0;">Create and manage assignments for your classes</p>
    </div>
    <button class="btn-custom btn-primary-custom" data-bs-toggle="modal" data-bs-target="#createAssignmentModal">
        <i class="fas fa-plus"></i> Create Assignment
    </button>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card primary">
        <div class="stat-icon"><i class="fas fa-tasks"></i></div>
        <div class="stat-value">{{ assignments|length }}</div>
        <div class="stat-label">Total Assignments</div>
    </div>
    <div class="stat-card warning">
        <div class="stat-icon"><i class="fas fa-clock"></i></div>
        <div class="stat-value">{{ assignments|selectattr('status', 'equalto', 'Pending')|list|length }}</div>
        <div class="stat-label">Needs Grading</div>
    </div>
    <div class="stat-card success">
        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
        <div class="stat-value">{{ assignments|selectattr('status', 'equalto', 'Completed')|list|length }}</div>
        <div class="stat-label">Fully Graded</div>
    </div>
    <div class="stat-card info">
        <div class="stat-icon"><i class="fas fa-file-upload"></i></div>
        <div class="stat-value">{{ assignments|sum(attribute='total_submissions') }}</div>
        <div class="stat-label">Total Submissions</div>
    </div>
</div>

<!-- Filter Tabs -->
<div style="margin-bottom: 1.5rem;">
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button class="btn-custom btn-primary-custom filter-btn active" data-filter="all"
            onclick="filterAssignments('all')">
            All Assignments
        </button>
        <button class="btn-custom btn-outline-custom filter-btn" data-filter="pending"
            onclick="filterAssignments('pending')">
            Pending Grading
        </button>
        <button class="btn-custom btn-outline-custom filter-btn" data-filter="completed"
            onclick="filterAssignments('completed')">
            Completed
        </button>
    </div>
</div>

<!-- Assignments Table -->
<div class="content-card">
    <div class="card-header">
        <h4><i class="fas fa-list"></i> All Assignments</h4>
        <input type="text" id="searchInput" placeholder="Search assignments..."
            style="padding: 0.625rem 1rem; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 0.9rem; max-width: 300px;">
    </div>

    <div class="table-responsive">
        <table class="table table-hover" id="assignmentsTable">
            <thead>
                <tr>
                    <th>Assignment Title</th>
                    <th>Class</th>
                    <th>Due Date</th>
                    <th>Submissions</th>
                    <th>Graded</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for assignment in assignments %}
                <tr data-status="{{ assignment.status|lower }}">
                    <td>
                        <strong>{{ assignment.title }}</strong>
                    </td>
                    <td>
                        <span class="badge badge-submitted">{{ assignment.class_name }}</span>
                    </td>
                    <td>{{ assignment.due_date }}</td>
                    <td>
                        <span style="font-weight: 600;">{{ assignment.total_submissions }}</span>
                    </td>
                    <td>
                        <span style="font-weight: 600; color: var(--success-color);">{{ assignment.graded }}</span>
                    </td>
                    <td>
                        {% if assignment.status == 'Completed' %}
                        <span class="badge badge-graded">{{ assignment.status }}</span>
                        {% elif assignment.status == 'Pending' %}
                        <span class="badge badge-pending">{{ assignment.status }}</span>
                        {% else %}
                        <span class="badge badge-submitted">{{ assignment.status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.25rem;">
                            <a href="{{ url_for('teacher_bp.view_assignment', assignment_id=assignment.id) }}"
                                class="btn-custom btn-outline-custom"
                                style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{{ url_for('teacher_bp.grade_assignment', assignment_id=assignment.id) }}"
                                class="btn-custom btn-outline-custom"
                                style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                <i class="fas fa-check"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <i class="fas fa-tasks"></i>
                            <h5>No assignments yet</h5>
                            <p>Create your first assignment to get started</p>
                            <button class="btn-custom btn-primary-custom" data-bs-toggle="modal"
                                data-bs-target="#createAssignmentModal">
                                <i class="fas fa-plus"></i> Create Assignment
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create Assignment Modal -->
<div class="modal fade" id="createAssignmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 15px; border: none;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border-radius: 15px 15px 0 0;">
                <h5 class="modal-title"><i class="fas fa-plus-circle"></i> Create New Assignment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="createAssignmentForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 500;">Assignment Title *</label>
                        <input type="text" class="form-control" name="title" required style="border-radius: 10px;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 500;">Description</label>
                        <textarea class="form-control" name="description" rows="4"
                            style="border-radius: 10px;"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 500;">Class *</label>
                        <select class="form-select" name="class_id" required style="border-radius: 10px;">
                            <option value="">Select a class</option>
                            {% for cls in classes %}
                            <option value="{{ cls.id }}">{{ cls.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 500;">Due Date</label>
                        <input type="date" class="form-control" name="due_date" style="border-radius: 10px;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 500;">Upload Assignment Files</label>
                        <div style="border: 2px dashed #d1d5db; border-radius: 10px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease;"
                            id="dropZone">
                            <input type="file" id="assignmentFile" name="assignment_file" multiple
                                style="display: none;">
                            <div>
                                <i class="fas fa-cloud-upload-alt"
                                    style="font-size: 2rem; color: #6b7280; margin-bottom: 0.5rem; display: block;"></i>
                                <p style="margin: 0.5rem 0; color: #6b7280; font-size: 0.9rem;">
                                    Drag and drop files here or <span
                                        style="color: var(--primary-color); font-weight: 500; text-decoration: underline;">click
                                        to browse</span>
                                </p>
                                <p style="margin: 0; color: #9ca3af; font-size: 0.8rem;">Supported: PDF, DOC, DOCX, TXT
                                    (Max 10MB per file)</p>
                            </div>
                            <div id="fileList" style="margin-top: 1rem; text-align: left;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 2px solid var(--light-bg);">
                    <button type="button" class="btn-custom btn-outline-custom" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn-custom btn-primary-custom">
                        <i class="fas fa-save"></i> Create Assignment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .filter-btn.active {
        background: var(--primary-color) !important;
        color: white !important;
        border-color: var(--primary-color) !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // File upload handling
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('assignmentFile');
    const fileList = document.getElementById('fileList');
    let selectedFiles = [];

    // Click to browse
    dropZone.addEventListener('click', () => fileInput.click());

    // Drag and drop
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = 'var(--primary-color)';
        dropZone.style.backgroundColor = '#f3f4f6';
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.style.borderColor = '#d1d5db';
        dropZone.style.backgroundColor = 'transparent';
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#d1d5db';
        dropZone.style.backgroundColor = 'transparent';

        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
    });

    function handleFiles(files) {
        selectedFiles = [];
        fileList.innerHTML = '';

        files.forEach((file, index) => {
            if (file.size > 10 * 1024 * 1024) {
                alert(`File "${file.name}" is too large (max 10MB)`);
                return;
            }

            selectedFiles.push(file);

            const fileItem = document.createElement('div');
            fileItem.style.display = 'flex';
            fileItem.style.justifyContent = 'space-between';
            fileItem.style.alignItems = 'center';
            fileItem.style.padding = '0.5rem';
            fileItem.style.backgroundColor = '#f9fafb';
            fileItem.style.borderRadius = '5px';
            fileItem.style.marginBottom = '0.5rem';
            fileItem.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-file" style="color: #6b7280;"></i>
                    <div>
                        <p style="margin: 0; font-size: 0.9rem; font-weight: 500;">${file.name}</p>
                        <p style="margin: 0; font-size: 0.8rem; color: #9ca3af;">${(file.size / 1024).toFixed(2)} KB</p>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            fileList.appendChild(fileItem);
        });

        if (selectedFiles.length > 0) {
            fileInput.files = createFileList(selectedFiles);
        }
    }

    function removeFile(index) {
        selectedFiles.splice(index, 1);
        handleFiles(selectedFiles);
    }

    function createFileList(files) {
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));
        return dt.files;
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('keyup', function () {
        const searchValue = this.value.toLowerCase();
        const table = document.getElementById('assignmentsTable');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchValue) ? '' : 'none';
        }
    });

    // Filter functionality
    function filterAssignments(filter) {
        const rows = document.querySelectorAll('#assignmentsTable tbody tr');
        const buttons = document.querySelectorAll('.filter-btn');

        // Update active button
        buttons.forEach(btn => {
            btn.classList.remove('active');
            btn.classList.remove('btn-primary-custom');
            btn.classList.add('btn-outline-custom');
        });

        const activeBtn = document.querySelector(`[data-filter="${filter}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
            activeBtn.classList.add('btn-primary-custom');
            activeBtn.classList.remove('btn-outline-custom');
        }

        // Filter rows
        rows.forEach(row => {
            if (filter === 'all') {
                row.style.display = '';
            } else {
                const status = row.getAttribute('data-status');
                row.style.display = status === filter ? '' : 'none';
            }
        });
    }

    // Create assignment form submission
    document.getElementById('createAssignmentForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        formData.append('csrf_token', getCSRFToken());

        fetch('{{ url_for("teacher_bp.create_assignment") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error creating assignment: ' + error);
            });
    });
</script>
{% endblock %}