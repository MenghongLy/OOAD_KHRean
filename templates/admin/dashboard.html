{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}
{% block sidebar_subtitle %}Admin Portal{% endblock %}

{% block sidebar_menu %}
<li>
    <a href="{{ url_for('admin_bp.dashboard') }}" class="active">
        <i class="fas fa-home"></i> Dashboard
    </a>
</li>
<li><a href="{{ url_for('admin_bp.manage_users') }}"><i class="fas fa-users-cog"></i> Manage Users</a></li>
<li><a href="{{ url_for('admin_bp.manage_teachers') }}"><i class="fas fa-chalkboard-teacher"></i> Manage Teachers</a>
</li>
<li><a href="{{ url_for('admin_bp.manage_students') }}"><i class="fas fa-user-graduate"></i> Manage Students</a></li>
<li><a href="{{ url_for('admin_bp.manage_assignments') }}"><i class="fas fa-tasks"></i> Manage Assignments</a></li>
<li><a href="{{ url_for('admin_bp.manage_roles') }}"><i class="fas fa-user-shield"></i> Manage Roles</a></li>
<li><a href="{{ url_for('admin_bp.edit_profile') }}"><i class="fas fa-user-edit"></i> Edit Profile</a></li>
<li style="margin-top:2rem;">
    <a href="{{ url_for('auth_bp.logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
</li>
{% endblock %}

{% block user_avatar %}
{{ admin.get('first_name','')[0] if admin.get('first_name') else '?' }}{{ admin.get('last_name','')[0] if
admin.get('last_name') else '?' }}
{% endblock %}

{% block user_name %}
{{ admin.get('first_name','N/A') }} {{ admin.get('last_name','') }}
{% endblock %}

{% block user_id %}
Admin ID: {{ admin.get('id','N/A') }}
{% endblock %}

{% block content %}
<div style="margin-bottom:1.5rem;">
    <h2 style="font-weight:700;color:#1f2937;">Admin Dashboard</h2>
    <p style="color:#6b7280;">Complete system overview and management</p>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show" style="border-radius:12px;">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<!-- Stats -->
<div class="stats-grid">
    <div class="stat-card primary">
        <div class="stat-icon"><i class="fas fa-users"></i></div>
        <div class="stat-value">{{ stats.get('total_users',0) }}</div>
        <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card success">
        <div class="stat-icon"><i class="fas fa-chalkboard-teacher"></i></div>
        <div class="stat-value">{{ stats.get('total_teachers',0) }}</div>
        <div class="stat-label">Total Teachers</div>
    </div>
    <div class="stat-card info">
        <div class="stat-icon"><i class="fas fa-user-graduate"></i></div>
        <div class="stat-value">{{ stats.get('total_students',0) }}</div>
        <div class="stat-label">Total Students</div>
    </div>
    <div class="stat-card warning">
        <div class="stat-icon"><i class="fas fa-tasks"></i></div>
        <div class="stat-value">{{ stats.get('total_assignments',0) }}</div>
        <div class="stat-label">Total Assignments</div>
    </div>
</div>

<!-- Quick Actions -->
<div class="content-card">
    <div class="card-header">
        <h4><i class="fas fa-bolt"></i> Quick Actions</h4>
    </div>
    <div class="grid-actions">
        <a href="{{ url_for('admin_bp.add_user') }}" class="btn-custom btn-primary-custom"><i
                class="fas fa-user-plus"></i> Add New User</a>
        <a href="{{ url_for('admin_bp.add_teacher') }}" class="btn-custom btn-success-custom"><i
                class="fas fa-chalkboard-teacher"></i> Add Teacher</a>
        <a href="{{ url_for('admin_bp.add_student') }}" class="btn-custom btn-success-custom"><i
                class="fas fa-user-graduate"></i> Add Student</a>
        <a href="{{ url_for('admin_bp.system_settings') }}" class="btn-custom btn-outline-custom"><i
                class="fas fa-cog"></i> System Settings</a>
    </div>
</div>

<!-- Two Column Grid -->
<div class="two-column-grid">

    <!-- Recent Users -->
    <div class="content-card">
        <div class="card-header">
            <h4><i class="fas fa-users"></i> Recent Users</h4>
            <a href="{{ url_for('admin_bp.manage_users') }}" class="btn-custom btn-primary-custom">View All</a>
        </div>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in recent_users %}
                    <tr>
                        <td>
                            <div class="user-entry">
                                <div class="avatar-square">{{ user.get('username','?')[0] }}</div>
                                {{ user.get('username','N/A') }}
                            </div>
                        </td>
                        <td>
                            {% if user.get('role')=='teacher' %}<span class="badge badge-graded">Teacher</span>
                            {% elif user.get('role')=='student' %}<span class="badge badge-submitted">Student</span>
                            {% else %}<span class="badge badge-late">Admin</span>{% endif %}
                        </td>
                        <td><span class="badge badge-submitted">Active</span></td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3">
                            <div class="empty-state"><i class="fas fa-users"></i>No users yet</div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="content-card">
        <div class="card-header">
            <h4><i class="fas fa-history"></i> Recent Activity</h4>
            <a href="{{ url_for('admin_bp.activity_log') }}" class="btn-custom btn-primary-custom">View All</a>
        </div>
        <div class="activity-log">
            {% for a in recent_activities %}
            <div class="activity-item">
                <div class="activity-icon {{ a.get('type') }}">
                    <i
                        class="fas {% if a.get('type')=='user_added' %}fa-user-plus{% elif a.get('type')=='user_deleted' %}fa-user-minus{% elif a.get('type')=='role_changed' %}fa-user-shield{% else %}fa-info-circle{% endif %}"></i>
                </div>
                <div class="activity-text">
                    <p>{{ a.get('description','') }}</p>
                    <span>{{ a.get('timestamp','') }}</span>
                </div>
            </div>
            {% else %}
            <div class="empty-state"><i class="fas fa-history"></i>No recent activity</div>
            {% endfor %}
        </div>
    </div>

</div>

<!-- Roles Overview -->
<div class="content-card">
    <div class="card-header">
        <h4><i class="fas fa-user-shield"></i> Role Management Overview</h4>
        <a href="{{ url_for('admin_bp.manage_roles') }}" class="btn-custom btn-primary-custom">Manage Roles</a>
    </div>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>User Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Joined</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in all_users %}
                <tr>
                    <td>
                        <div class="user-entry">
                            <div class="avatar-square">{{ user.get('first_name','?')[0] }}{{
                                user.get('last_name','?')[0] }}</div>
                            {{ user.get('first_name','N/A') }} {{ user.get('last_name','') }}
                        </div>
                    </td>
                    <td>{{ user.get('email','N/A') }}</td>
                    <td>{{ user.get('role','N/A')|capitalize }}</td>
                    <td>{{ user.get('created_at','') }}</td>
                    <td>
                        <a href="{{ url_for('admin_bp.change_role',user_id=user.get('id')) }}"
                            class="btn-custom btn-outline-custom"><i class="fas fa-exchange-alt"></i> Change</a>
                        <a href="{{ url_for('admin_bp.view_user',user_id=user.get('id')) }}"
                            class="btn-custom btn-primary-custom"><i class="fas fa-eye"></i></a>
                        {% if user.get('role') != 'admin' %}
                        <button onclick="deleteUser({{ user.get('id') }})" class="btn-custom btn-danger">Delete</button>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5">
                        <div class="empty-state"><i class="fas fa-users"></i>No users found</div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="delete-modal">
    <div class="delete-box">
        <h5>Confirm Delete</h5>
        <p>Are you sure you want to delete this user?</p>
        <button class="btn-custom btn-danger" onclick="confirmDelete()">Yes, Delete</button>
        <button class="btn-custom btn-outline-custom" onclick="closeDeleteModal()">Cancel</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function deleteUser(id) {
        const confirmDelete = window.confirm("Are you sure you want to delete this user?");
        if (!confirmDelete) return;

        // Build URL dynamically in JS
        const url = `/admin/users/${id}/delete`;

        fetchWithCSRF(url, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) location.reload();
                else alert(data.message || 'Delete failed');
            })
            .catch(err => alert('Error: ' + err));
    }
</script>

{% endblock %}
{% block extra_css %}
<style>
    .two-column-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
    }

    .avatar-square {
        width: 35px;
        height: 35px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }

    .user-entry {
        display: flex;
        align-items: center;
        gap: .75rem;
    }

    .delete-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, .5);
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .delete-box {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        max-width: 350px;
        width: 90%;
    }

    .activity-log::-webkit-scrollbar {
        width: 6px;
    }

    .activity-log::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 10px;
    }

    .btn-custom:hover {
        transform: translateY(-2px);
        transition: .3s;
    }

    @media(max-width:768px) {
        .two-column-grid {
            grid-template-columns: 1fr !important;
        }
    }
</style>
{% endblock %}