{% extends "base.html" %}

{% block title %}Change User Role{% endblock %}

{% block sidebar_subtitle %}Admin Portal{% endblock %}

{% block sidebar_menu %}
<li>
    <a href="{{ url_for('admin_bp.dashboard') }}">
        <i class="fas fa-home"></i>
        Dashboard
    </a>
</li>
<li>
    <a href="{{ url_for('admin_bp.manage_users') }}">
        <i class="fas fa-users-cog"></i>
        Manage Users
    </a>
</li>
<li>
    <a href="{{ url_for('admin_bp.manage_teachers') }}">
        <i class="fas fa-chalkboard-teacher"></i>
        Manage Teachers
    </a>
</li>
<li>
    <a href="{{ url_for('admin_bp.manage_students') }}">
        <i class="fas fa-user-graduate"></i>
        Manage Students
    </a>
</li>
<li>
    <a href="{{ url_for('admin_bp.manage_assignments') }}">
        <i class="fas fa-tasks"></i>
        Manage Assignments
    </a>
</li>
<li>
    <a href="{{ url_for('admin_bp.manage_roles') }}" class="active">
        <i class="fas fa-user-shield"></i>
        Manage Roles
    </a>
</li>
<li>
    <a href="{{ url_for('admin_bp.edit_profile') }}">
        <i class="fas fa-user-edit"></i>
        Edit Profile
    </a>
</li>
<li style="margin-top: 2rem;">
    <a href="{{ url_for('auth_bp.logout') }}">
        <i class="fas fa-sign-out-alt"></i>
        Logout
    </a>
</li>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div style="margin-bottom: 2rem;">
    <a href="{{ url_for('admin_bp.manage_roles') }}" class="btn-custom btn-outline-custom" style="margin-bottom: 1rem;">
        <i class="fas fa-arrow-left"></i> Back to Roles
    </a>
    <h2 style="font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">Change User Role</h2>
    <p style="color: #6b7280; margin: 0;">Modify the role for {{ user.username }}</p>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert"
    style="border-radius: 12px; margin-bottom: 1.5rem;">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; max-width: 1000px;">
    <!-- User Information Card -->
    <div class="content-card">
        <div class="card-header">
            <h4><i class="fas fa-user"></i> User Information</h4>
        </div>
        <div style="padding-top: 0.5rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                <div
                    style="width: 60px; height: 60px; border-radius: 12px; background: linear-gradient(135deg, var(--info-color), #3b82f6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.5rem;">
                    {{ user.username[0].upper() }}
                </div>
                <div>
                    <h5 style="margin: 0; font-weight: 600; color: #1f2937;">{{ user.username }}</h5>
                    <p style="margin: 0.25rem 0 0; color: #6b7280; font-size: 0.9rem;">{{ user.email }}</p>
                </div>
            </div>

            <div
                style="display: flex; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light-bg);">
                <span style="color: #6b7280;">User ID</span>
                <span style="font-weight: 600; color: #1f2937;">{{ user.id }}</span>
            </div>

            <div
                style="display: flex; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light-bg);">
                <span style="color: #6b7280;">Account Created</span>
                <span style="font-weight: 600; color: #1f2937;">{{ user.created_at.strftime('%b %d, %Y') if
                    user.created_at else 'N/A' }}</span>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280;">Current Role</span>
                <span style="font-weight: 600;">
                    {% if user.role == 'admin' %}
                    <span class="badge badge-late"><i class="fas fa-shield-alt"></i> Admin</span>
                    {% elif user.role == 'teacher' %}
                    <span class="badge badge-graded"><i class="fas fa-chalkboard-teacher"></i> Teacher</span>
                    {% elif user.role == 'student' %}
                    <span class="badge badge-submitted"><i class="fas fa-user-graduate"></i> Student</span>
                    {% endif %}
                </span>
            </div>
        </div>
    </div>

    <!-- Change Role Form -->
    <div class="content-card">
        <div class="card-header">
            <h4><i class="fas fa-exchange-alt"></i> Assign New Role</h4>
        </div>

        <form method="POST" style="padding-top: 0.5rem;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div style="margin-bottom: 2rem;">
                <label style="display: block; margin-bottom: 1rem; font-weight: 600; color: #1f2937;">Select Role
                    *</label>

                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Admin Role -->
                    <div style="padding: 1rem; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;"
                        onclick="selectRole('admin', this)">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <input type="radio" name="role" value="admin" id="role-admin" style="cursor: pointer;">
                            <label for="role-admin" style="margin: 0; cursor: pointer; flex: 1;">
                                <div style="font-weight: 600; color: #1f2937;">
                                    <i class="fas fa-shield-alt"></i> Administrator
                                </div>
                                <small style="color: #6b7280;">Full system access and management privileges</small>
                            </label>
                        </div>
                    </div>

                    <!-- Teacher Role -->
                    <div style="padding: 1rem; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;"
                        onclick="selectRole('teacher', this)">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <input type="radio" name="role" value="teacher" id="role-teacher" style="cursor: pointer;">
                            <label for="role-teacher" style="margin: 0; cursor: pointer; flex: 1;">
                                <div style="font-weight: 600; color: #1f2937;">
                                    <i class="fas fa-chalkboard-teacher"></i> Teacher
                                </div>
                                <small style="color: #6b7280;">Can create assignments and grade submissions</small>
                            </label>
                        </div>
                    </div>

                    <!-- Student Role -->
                    <div style="padding: 1rem; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;"
                        onclick="selectRole('student', this)">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <input type="radio" name="role" value="student" id="role-student" style="cursor: pointer;">
                            <label for="role-student" style="margin: 0; cursor: pointer; flex: 1;">
                                <div style="font-weight: 600; color: #1f2937;">
                                    <i class="fas fa-user-graduate"></i> Student
                                </div>
                                <small style="color: #6b7280;">Can view assignments and submit work</small>
                            </label>
                        </div>
                    </div>
                </div>

                {% if user.role %}
                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--light-bg); border-radius: 10px;">
                    <small style="color: #6b7280;">
                        <i class="fas fa-info-circle"></i>
                        Current role: <strong>{{ user.role }}</strong>
                    </small>
                </div>
                {% endif %}
            </div>

            <!-- Form Actions -->
            <div
                style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1.5rem; border-top: 1px solid var(--light-bg);">
                <a href="{{ url_for('admin_bp.manage_roles') }}" class="btn-custom btn-outline-custom">
                    <i class="fas fa-times"></i> Cancel
                </a>
                <button type="submit" class="btn-custom btn-primary-custom">
                    <i class="fas fa-save"></i> Change Role
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function selectRole(role, element) {
        // Remove active state from all role divs
        document.querySelectorAll('[onclick^="selectRole"]').forEach(el => {
            el.style.borderColor = '#e5e7eb';
            el.style.background = 'transparent';
        });

        // Add active state to clicked element
        element.style.borderColor = 'var(--primary-color)';
        element.style.background = 'var(--light-bg)';

        // Check the radio button
        document.getElementById(`role-${role}`).checked = true;
    }

    // Set initial selection if role is already set
    document.addEventListener('DOMContentLoaded', function () {
        const currentRole = '{{ user.role }}';
        if (currentRole) {
            const radioButton = document.getElementById(`role-${currentRole}`);
            if (radioButton) {
                radioButton.checked = true;
                selectRole(currentRole, radioButton.closest('[onclick^="selectRole"]'));
            }
        }
    });
</script>
{% endblock %}